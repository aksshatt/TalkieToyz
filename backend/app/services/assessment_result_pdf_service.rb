class AssessmentResultPdfService
  require 'prawn'
  require 'prawn/table'

  def initialize(assessment_result)
    @assessment_result = assessment_result
    @assessment = assessment_result.assessment
  end

  def generate
    Prawn::Document.new(page_size: 'A4', margin: 50) do |pdf|
      # Header with logo area
      pdf.font 'Helvetica'
      pdf.text 'TalkieToys', size: 24, style: :bold, color: '00897B'
      pdf.text 'Speech & Language Development Assessment Report', size: 14, color: '5D4037'
      pdf.move_down 20

      # Child Information Section
      pdf.stroke_horizontal_rule
      pdf.move_down 10
      pdf.text 'Child Information', size: 16, style: :bold, color: '00897B'
      pdf.move_down 10

      child_age_years = @assessment_result.child_age_months / 12
      child_age_months = @assessment_result.child_age_months % 12
      age_display = child_age_months > 0 ? "#{child_age_years} years #{child_age_months} months" : "#{child_age_years} years"

      child_info = [
        ['Name:', @assessment_result.child_name],
        ['Age:', age_display],
        ['Assessment:', @assessment.title],
        ['Completed:', @assessment_result.completed_at.strftime('%B %d, %Y at %I:%M %p')]
      ]

      pdf.table(child_info, cell_style: { borders: [], padding: [5, 10] }, column_widths: [120, 350]) do
        column(0).font_style = :bold
      end

      pdf.move_down 20

      # Overall Score Section
      pdf.stroke_horizontal_rule
      pdf.move_down 10
      pdf.text 'Overall Performance', size: 16, style: :bold, color: '00897B'
      pdf.move_down 10

      score_level = get_score_level(@assessment_result.percentage_score)

      # Score box
      pdf.fill_color score_level[:color]
      pdf.fill_rectangle [0, pdf.cursor], 495, 100
      pdf.fill_color '000000'

      pdf.bounding_box([20, pdf.cursor + 80], width: 455, height: 80) do
        pdf.fill_color 'FFFFFF'
        pdf.text "#{@assessment_result.percentage_score.round}%", size: 36, style: :bold, align: :center
        pdf.move_down 5
        pdf.text score_level[:label], size: 18, style: :bold, align: :center
        pdf.move_down 5
        pdf.text score_level[:message], size: 12, align: :center
        pdf.fill_color '000000'
      end

      pdf.move_down 20

      # Skill Area Breakdown
      if @assessment_result.scores.present? && @assessment_result.scores.any?
        pdf.stroke_horizontal_rule
        pdf.move_down 10
        pdf.text 'Skill Area Breakdown', size: 16, style: :bold, color: '00897B'
        pdf.move_down 10

        skill_data = [['Skill Area', 'Score', 'Performance']]
        @assessment_result.scores.each do |category, score|
          percentage = (score.to_f / 10) * 100
          performance = case percentage
                       when 80..100 then 'Excellent'
                       when 60...80 then 'Good'
                       when 40...60 then 'Fair'
                       else 'Needs Focus'
                       end
          skill_data << [category.to_s.titleize.gsub('_', ' '), "#{score}/10", performance]
        end

        pdf.table(skill_data, header: true, width: 495,
                  cell_style: { padding: [8, 10], borders: [:bottom], border_color: 'CCCCCC' }) do
          row(0).font_style = :bold
          row(0).background_color = 'E0F2F1'
          row(0).text_color = '00897B'
          column(1).align = :center
          column(2).align = :center
        end

        pdf.move_down 20
      end

      # Recommendations
      if @assessment_result.recommendations.present?
        pdf.stroke_horizontal_rule
        pdf.move_down 10
        pdf.text 'Personalized Recommendations', size: 16, style: :bold, color: '00897B'
        pdf.move_down 10

        if @assessment_result.recommendations['message'].present?
          pdf.text @assessment_result.recommendations['message'], size: 12, leading: 5
          pdf.move_down 10
        end

        if @assessment_result.recommendations['tips'].present? && @assessment_result.recommendations['tips'].any?
          pdf.text 'Actionable Tips for Progress:', size: 14, style: :bold, color: '5D4037'
          pdf.move_down 5

          @assessment_result.recommendations['tips'].each_with_index do |tip, index|
            pdf.text "#{index + 1}. #{tip}", size: 11, leading: 4
            pdf.move_down 5
          end
        end
      end

      # Footer
      pdf.move_down 30
      pdf.stroke_horizontal_rule
      pdf.move_down 10
      pdf.text 'This report was generated by TalkieToys Assessment Platform', size: 10, align: :center, color: '9E9E9E'
      pdf.text 'For questions or professional consultation, visit www.talkietoys.com', size: 10, align: :center, color: '9E9E9E'

      # Page numbers
      options = {
        at: [pdf.bounds.right - 100, 0],
        width: 100,
        align: :right,
        size: 10,
        color: '9E9E9E'
      }
      pdf.number_pages 'Page <page> of <total>', options
    end
  end

  private

  def get_score_level(percentage)
    if percentage >= 80
      { label: 'Excellent Progress', color: '00897B', message: 'Outstanding! Your child is showing great progress.' }
    elsif percentage >= 60
      { label: 'Good Progress', color: '0288D1', message: 'Great work! Your child is developing well.' }
    elsif percentage >= 40
      { label: 'Making Progress', color: 'FFA726', message: 'Your child is on the right track with room to grow.' }
    else
      { label: 'Needs Support', color: 'EF5350', message: 'With the right support, your child can make great progress.' }
    end
  end
end
